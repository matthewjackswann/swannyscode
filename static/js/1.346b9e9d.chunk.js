(this.webpackJsonpswannyscode=this.webpackJsonpswannyscode||[]).push([[1],{152:function(e,c,n){"use strict";n.r(c);var s,t,r,a,i,d=n(19),f=(n(1),n(86)),o=n(20),l=n(0);c.default=function(){return Object(l.jsxs)("div",{children:[Object(l.jsx)("h1",{children:"Space Pirates"}),Object(l.jsx)("br",{}),Object(l.jsx)("p",{children:"This is one of the cryptography challenges in the HTB Uni CTF Qualifiers 2021"}),Object(l.jsx)("br",{}),Object(l.jsx)("p",{children:"We are given a zipped folder containing two files. A python script which encodes a secret key and the file created by the script."}),Object(l.jsx)("br",{}),Object(l.jsxs)(f.a,{children:[Object(l.jsx)("h4",{children:"chall.py"}),Object(l.jsx)("div",{className:"code",children:Object(l.jsx)("code",{className:"prettyprint",children:"from sympy import *\nfrom hashlib import md5\nfrom Crypto.Cipher import AES\nfrom Crypto.Util.Padding import pad\nfrom random import randint, randbytes,seed\nfrom Crypto.Util.number import bytes_to_long\n\nFLAG = b'HTB{dummyflag}'\nclass Shamir:\n    def __init__(self, prime, k, n):\n        self.p = prime\n        self.secret = randint(1,self.p-1)\n        self.k = k\n        self.n = n\n        self.coeffs = [self.secret]\n        self.x_vals = []\n        self.y_vals = []\n\n    def next_coeff(self, val):\n        return int(md5(val.to_bytes(32, byteorder=\"big\")).hexdigest(),16)\n\n    def calc_coeffs(self):\n        for i in range(1,self.n+1):\n            self.coeffs.append(self.next_coeff(self.coeffs[i-1]))\n\n    def calc_y(self, x):\n        y = 0\n        for i, coeff in enumerate(self.coeffs):        \n            y +=coeff *x**i\n        return y%self.p\n\n\n    def create_pol(self):\n        self.calc_coeffs()\n        self.coeffs = self.coeffs[:self.k]\n        for i in range(self.n):\n            x = randint(1,self.p-1)\n            self.x_vals.append(x)\n            self.y_vals.append(self.calc_y(x))\n\n    def get_share(self):\n        return self.x_vals[0], self.y_vals[0]\n\n\ndef main():\n    sss = Shamir(92434467187580489687, 10, 18)\n    sss.create_pol()\n    share = sss.get_share()\n    seed(sss.secret)\n    key = randbytes(16)\n    cipher = AES.new(key, AES.MODE_ECB)\n    enc_FLAG = cipher.encrypt(pad(FLAG,16)).hex()\n    \n    f = open('msg.enc', 'w')\n    f.write('share: ' + str(share) + '\\n')\n    f.write('coefficient: ' + str(sss.coeffs[1]) + '\\n')\n    f.write('secret message: ' + str(enc_FLAG) + '\\n')\n    f.close()\n\nif __name__ == \"__main__\":\n    main()\n\n"})})]}),Object(l.jsx)("br",{}),Object(l.jsxs)(f.a,{children:[Object(l.jsx)("h4",{children:"msg.enc"}),Object(l.jsx)("br",{}),Object(l.jsxs)("div",{style:{overflowWrap:"break-word"},children:[Object(l.jsx)("p",{children:"share: (21202245407317581090, 11086299714260406068)"}),Object(l.jsx)("p",{children:"coefficient: 93526756371754197321930622219489764824"}),Object(l.jsx)("p",{children:"secret message: 1aaad05f3f187bcbb3fb5c9e233ea339082062fc10a59604d96bcc38d0af92cd842ad7301b5b72bd5378265dae0bc1c1e9f09a90c97b35cfadbcfe259021ce495e9b91d29f563ae7d49b66296f15e7999c9e547fac6f1a2ee682579143da511475ea791d24b5df6affb33147d57718eaa5b1b578230d97f395c458fc2c9c36525db1ba7b1097ad8f5df079994b383b32695ed9a372ea9a0eb1c6c18b3d3d43bd2db598667ef4f80845424d6c75abc88b59ef7c119d505cd696ed01c65f374a0df3f331d7347052faab63f76f587400b6a6f8b718df1db9cebe46a4ec6529bc226627d39baca7716a4c11be6f884c371b08d87c9e432af58c030382b737b9bb63045268a18455b9f1c4011a984a818a5427231320ee7eca39bdfe175333341b7c"})]})]}),Object(l.jsx)("br",{}),Object(l.jsxs)("p",{children:["First I looked how the flag is given to us. It's encrypted and then stored in ",Object(l.jsx)("i",{children:"msg.enc"})," as the secret message"]}),Object(l.jsx)("div",{className:"code",children:Object(l.jsx)("code",{className:"prettyprint lang-py",children:"seed(sss.secret)\nkey = randbytes(16)\ncipher = AES.new(key, AES.MODE_ECB)\nenc_FLAG = cipher.encrypt(pad(FLAG,16)).hex()"})}),Object(l.jsxs)("p",{children:["The enconded flag is given to use after it's encrypted with a randomly generated key. We can also see that the random seed is set to ",Object(l.jsx)("b",{children:"sss.secret"}),". This means that if we can work out the value of ",Object(l.jsx)("b",{children:"sss.secret"}),", set the seed and then run randbytes(16) we will get the same key that is used to encrypt the message. We can then decrypt in to get the flag."]}),Object(l.jsx)("br",{}),Object(l.jsxs)("p",{children:["Looking into the class at where the value of ",Object(l.jsx)("b",{children:"secret"})," is set we can see that it's a random number between ",Object(l.jsx)("b",{children:"1"})," and ",Object(l.jsx)("b",{children:"92434467187580489687"}),". This is before the random seed is set so we can't exploit that to work out it's value. Instead we need to look at how this value effect other values and see if we can work backwards."]}),Object(l.jsx)("br",{}),Object(l.jsxs)("p",{children:["Next I went on to look at the coefficients as the first coefficient in the list is ",Object(l.jsx)("b",{children:"secret"}),". We are also given the second coefficient in the list as this is the coefficient in ",Object(l.jsx)("i",{children:"msg.enc"}),"."]}),Object(l.jsx)("br",{}),Object(l.jsx)("div",{className:"code",children:Object(l.jsx)("code",{className:"prettyprint lang-py",children:"# relevant code but slightly simplified\ndef next_coeff(val):\n    return int(md5(val).hexdigest(),16)\n\ndef calc_coeffs():\n    for i in range(1,n+1):\n        coeffs.append(next_coeff(coeffs[i-1]))\n\ndef create_pol():\n    calc_coeffs()\n    coeffs = coeffs[:k]\n    # other stuff after this\n\nsss = Shamir(92434467187580489687, 10, 18)\n# sets p = 92434467187580489687, k = 10, n = 18\n# coeffs = [secret]\nsss.create_pol()"})}),Object(l.jsxs)("p",{children:["In the function ",Object(l.jsx)("b",{children:"create_pol()"})," another function ",Object(l.jsx)("b",{children:"create_coeffs()"})," is called to set up the list of coefficients. This is done by calling the function ",Object(l.jsx)("b",{children:"next_coeff(val)"})," on the previous coefficient in the list."]}),Object(l.jsxs)("p",{children:["As we have the second coefficient we can use it to calculate the remaining coefficients. It also tells us that the hash of ",Object(l.jsx)("b",{children:"secret"})," is the second coefficient in the list. We can use this later for checking possible values of secret."]}),Object(l.jsx)("br",{}),Object(l.jsxs)("p",{children:["Now lets look at the two remaining values we are given: ",Object(l.jsx)("b",{children:"x_vals[0]"})," and ",Object(l.jsx)("b",{children:"y_vals[0]"}),"."]}),Object(l.jsx)("div",{className:"code",children:Object(l.jsx)("code",{className:"prettyprint lang-py",children:"# relevant code but slightly simplified\ndef calc_y(x):\n    y = 0\n    for i, coeff in enumerate(coeffs):\n        y += coeff * x**i\n    return y % p\n\ndef create_pol():\n    calc_coeffs() # coeffs are set up\n    coeffs = coeffs[:k]\n    for i in range(n):\n        x = randint(1,p-1)\n        x_vals.append(x)\n        y_vals.append(calc_y(x))\n\nsss = Shamir(92434467187580489687, 10, 18)\n# sets p = 92434467187580489687, k = 10, n = 18\n# coeffs = [secret]\nsss.create_pol()\n"})}),Object(l.jsxs)("p",{children:["As we are only given ",Object(l.jsx)("b",{children:"x_vals[0]"})," and ",Object(l.jsx)("b",{children:"y_vals[0]"})," we only need to look at the first loop where they are calculated. ",Object(l.jsx)("b",{children:"x"})," is randomly generated and used to calculate the ",Object(l.jsx)("b",{children:"y"})," value. Their relation can be summerised where ",Object(l.jsx)("b",{children:"c"})," is the list of coefficients:"]}),Object(l.jsx)(o.a,{tex:String.raw(s||(s=Object(d.a)(["y  equiv  sum_{r=0}^{ mid c mid } c[r]x^{r}  equiv  c[0] x^{0} + sum_{r=1}^{ mid c mid } c[r]x^{r} mod p"],["y  \\equiv  \\sum_{r=0}^{ \\mid c \\mid } c[r]x^{r}  \\equiv  c[0] x^{0} + \\sum_{r=1}^{ \\mid c \\mid } c[r]x^{r} \\mod p"])))}),Object(l.jsx)(o.a,{tex:String.raw(t||(t=Object(d.a)(["y  equiv  c[0] + sum_{r=1}^{ mid c mid } c[r]x^{r} mod p"],["y  \\equiv  c[0] + \\sum_{r=1}^{ \\mid c \\mid } c[r]x^{r} \\mod p"])))}),Object(l.jsxs)("p",{children:["This is very useful as we know that ",Object(l.jsx)("b",{children:"c[0]"})," is ",Object(l.jsx)("b",{children:"secret"})," and between ",Object(l.jsx)("b",{children:"1"})," and ",Object(l.jsx)("b",{children:"p"}),". We also know every all other values of ",Object(l.jsx)("b",{children:"c"}),", and our value of ",Object(l.jsx)("b",{children:"x"})," and ",Object(l.jsx)("b",{children:"y"}),". We can then rearange to get the value of ",Object(l.jsx)("b",{children:"secret"}),"."]}),Object(l.jsx)(o.a,{tex:String.raw(r||(r=Object(d.a)(["y = c[0] mod p + sum_{r=1}^{ mid c mid } c[r]x^{r} mod p"],["y = c[0] \\mod p + \\sum_{r=1}^{ \\mid c \\mid } c[r]x^{r} \\mod p"])))}),Object(l.jsx)(o.a,{tex:String.raw(a||(a=Object(d.a)(["y  equiv  c[0] + sum_{r=1}^{ mid c mid } c[r]x^{r} mod p"],["y  \\equiv  c[0] + \\sum_{r=1}^{ \\mid c \\mid } c[r]x^{r} \\mod p"])))}),Object(l.jsx)(o.a,{tex:String.raw(i||(i=Object(d.a)(["c[0] equiv y - sum_{r=1}^{ mid c mid } c[r]x^{r} mod p"],["c[0] \\equiv y - \\sum_{r=1}^{ \\mid c \\mid } c[r]x^{r} \\mod p"])))}),Object(l.jsxs)("p",{children:["This can then be calculated to get the value of ",Object(l.jsx)("b",{children:"secret"}),"."]}),Object(l.jsx)("div",{className:"code",children:Object(l.jsx)("code",{className:"prettyprint lang-py",children:"ty = 0\nfor i in range(len(coeffs)):\n    ty += coeffs[i] * x**(i+1)\n# y = ty % p\n# ty should be equal to the value of y but is missing secret * x ^ 0 = secret\n# therefore (secret + ty) % p = y\ns = (y - (ty % p) + p) % p\nprint(x) # 39612257993477957104"})}),Object(l.jsx)("p",{children:"This can then be used to set the seed and retrieve the flag using the key."}),Object(l.jsx)("div",{className:"code",children:Object(l.jsx)("code",{className:"prettyprint lang-py",children:"seed(s)\nkey = randbytes(16)\ncipher = AES.new(key, AES.MODE_ECB)\nprint(cipher.decrypt(unhexlify(secret_message)).decode())\n'''\nThe treasure is located at galaxy VS-708.\nOur team needs 3 light years to reach it.\nOur solar cruise has its steam canons ready to fire in case we encounter enemies.\nNext time you will hear from us brother, everyone is going to be rich!\nHTB{1_d1dnt_kn0w_0n3_sh4r3_w45_3n0u9h!1337}\n'''"})}),Object(l.jsxs)(f.a,{children:[Object(l.jsx)("h4",{children:"Full solution"}),Object(l.jsx)("br",{}),Object(l.jsx)("p",{children:"Run in python 3.9"}),Object(l.jsx)("div",{className:"code",children:Object(l.jsx)("code",{className:"prettyprint",children:"from hashlib import md5\nfrom Crypto.Cipher import AES\nfrom random import randint, randbytes, seed\nfrom binascii import unhexlify\n\ncorrectHash = 93526756371754197321930622219489764824\n# correctHash = hash(secret)\n\ndef hash(val):\n    return int(md5(val.to_bytes(32, byteorder=\"big\")).hexdigest(),16)\n\n# list of coeff missing the first value\ncoeff = 93526756371754197321930622219489764824\ncoeffs = [coeff]\nfor i in range(8):\n    coeffs.append(int(md5(coeffs[i].to_bytes(32, byteorder=\"big\")).hexdigest(),16))\n\np = 92434467187580489687\nx = 21202245407317581090\ny = 11086299714260406068\n\nty = 0\nfor i in range(len(coeffs)):\n    ty += coeffs[i] * x**(i+1)\n\n# (secret + ty) % p = y\ns = (y - (ty % p) + p) % p\nif hash(s) == correctHash:\n    print(\"correctHash\")\n\nprint(s)\n\nseed(s)\nkey = randbytes(16)\nencrypted = '1aaad05f3f187bcbb3fb5c9e233ea339082062fc10a59604d96bcc38d0af92cd842ad7301b5b72bd5378265dae0bc1c1e9f09a90c97b35cfadbcfe259021ce495e9b91d29f563ae7d49b66296f15e7999c9e547fac6f1a2ee682579143da511475ea791d24b5df6affb33147d57718eaa5b1b578230d97f395c458fc2c9c36525db1ba7b1097ad8f5df079994b383b32695ed9a372ea9a0eb1c6c18b3d3d43bd2db598667ef4f80845424d6c75abc88b59ef7c119d505cd696ed01c65f374a0df3f331d7347052faab63f76f587400b6a6f8b718df1db9cebe46a4ec6529bc226627d39baca7716a4c11be6f884c371b08d87c9e432af58c030382b737b9bb63045268a18455b9f1c4011a984a818a5427231320ee7eca39bdfe175333341b7c'\ncipher = AES.new(key, AES.MODE_ECB)\nprint(cipher.decrypt(unhexlify(encrypted)).decode())\n'''\nThe treasure is located at galaxy VS-708.\nOur team needs 3 light years to reach it.\nOur solar cruise has its steam canons ready to fire in case we encounter enemies.\nNext time you will hear from us brother, everyone is going to be rich!\nHTB{1_d1dnt_kn0w_0n3_sh4r3_w45_3n0u9h!1337}\n'''\n"})})]}),Object(l.jsx)("br",{})]})}}}]);
//# sourceMappingURL=1.346b9e9d.chunk.js.map